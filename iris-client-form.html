<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iris-polymer-importer/iris-importer.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iris-polymer-screen-lock/iris-screen-lock.html">

<dom-module id="iris-client-form">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }
    </style>

    <paper-textarea label$="[[currentField.description]]" value="{{text}}"></paper-textarea>
    <iris-screen-lock id="locker"></iris-screen-lock>
  </template>

  <script>
    'use strict';
    (function() {
      Polymer({
        is: 'iris-client-form',
        properties: {
          text: {
            type: String,
            notify: true
          },
          filledFields: {
            type: Object,
            notify: true,
            value: {}
          },
          fieldsModel: {
            type: Object,
            observer: '_fieldsModelChanged'
          },
          currentFieldName: {
            type: String,
            notify: true
          },
          currentFieldNumber: {
            type: Number,
            notify: true,
            value: 0
          },
          currentField: {
            type: Object,
            notify: true
          },
          isFinished: {
            type: Boolean,
            notify: true,
            value: false
          },
          isFirst: {
            type: Boolean,
            notify: true,
            value: true
          }
        },
        _fieldsModelChanged() {
          this.reset();
        },
        validate() {

          let validate;

          if (this.currentField.validate instanceof Function) {
            this.$.locker.lock();
            validate = Promise.resolve(this.currentField.validate(this.filledFields))
          } else {
            validate = Promise.resolve(true);
          }

          validate.then(() => this.$.locker.unlock())

          return validate.catch((e) => {
            console.log('silent error', e);
            this.$.locker.unlock();
            return false;
          });
        },
        next() {
          this.storeValue();

          return this.validate().then((result) => {
            if (!result) {
              this.fire('validation-error', {
                field: this.currentField,
                name: this.currentFieldName
              });
              return false;
            }
            if (this.isFinished) return true;
            this.setParams(this.currentFieldNumber + 1)
          });
        },
        checkBorders() {
          let keys = _.keys(this.fieldsModel);
          this.set('isFinished', this.currentFieldNumber === keys.length - 1);
          this.set('isFirst', this.currentFieldNumber === 0);
        },
        setParams(current) {
          let keys = _.keys(this.fieldsModel);
          this.set('currentFieldNumber', current);
          this.set('currentFieldName', keys[this.currentFieldNumber]);
          this.set('currentField', this.fieldsModel[this.currentFieldName]);
          this.set('text', this.filledFields[this.currentFieldName] || '');

          this.checkBorders();
        },
        previous() {
          this.storeValue();

          return this.validate().then((result) => {
            if (!result) {
              this.fire('validation-error', {
                field: this.currentField,
                name: this.currentFieldName
              });
              return false;
            }
            if (this.isFirst) return true;
            this.setParams(this.currentFieldNumber - 1);
            return true;
          });
        },
        storeValue() {
          if (this.currentFieldName && this.text) {
            this.set('filledFields.' + this.currentFieldName, this.text)
          }
        },
        reset(fields) {
          this.filledFields = fields || Object.create(null);
          this.$.locker.unlock();
          this.setParams(0);
        }
      });
    })();
  </script>

</dom-module>